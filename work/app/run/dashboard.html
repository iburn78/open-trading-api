<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>OPTRADER Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
</head>
<body style="margin:0; padding:0; font-family:monospace;">

<div id="dashboards"></div>

<script>
const dashboards = document.getElementById("dashboards");

// active websockets { port: WebSocket }
const sockets = {};

// HTML panels { port: <pre> }
const panels = {};

// -------- create or return panel ----------
// function ensurePanel(port, name) {
//     if (panels[port]) return panels[port];

//     const pre = document.createElement("pre");
//     pre.style = `
//         font-family: monospace;
//         margin: 0;
//         padding: 10px;
//         border-bottom: 1px solid #ccc;
//         white-space: pre-wrap;
//     `;
//     pre.id = `panel-${port}`;
//     dashboards.appendChild(pre);

//     panels[port] = pre;
//     return pre;
// }
function ensurePanel(port, name) {
    if (panels[port]) return panels[port];

    const container = document.createElement("div");
    container.style = "border-bottom:1px solid #ccc; padding:8px";

    const title = document.createElement("div");
    title.textContent = `[${port} - ${name}]`;
    title.style = "font-weight:bold";

    const pre = document.createElement("pre");
    pre.style = "margin:0; white-space:pre-wrap;";

    const canvas = document.createElement("canvas");
    canvas.height = 200;

    container.appendChild(title);
    container.appendChild(canvas);
    container.appendChild(pre);
    dashboards.appendChild(container);

    panels[port] = { pre, canvas, chart: null };
    return panels[port];
}

function ensureChart(panel) {
    if (panel.chart) return panel.chart;

    panel.chart = new Chart(panel.canvas, {
        type: "candlestick",
        data: {
            datasets: [{
                label: "Bars",
                data: []
            }]
        },
        options: {
            responsive: true,
            parsing: false,
            scales: {
                x: {
                    type: "time",
                    time: { unit: "minute" }
                }
            }
        }
    });

    return panel.chart;
}

// -------- connect a websocket ----------
function connectWS(port, name) {
    if (sockets[port]) return;

    const ws = new WebSocket(`ws://127.0.0.1:${port}`);
    const panel = ensurePanel(port, name);

    ws.onopen = () => {
        panel.textContent = `[${port} - ${name}] Connected\n`;
    };

    // ws.onmessage = event => {
    //     panel.textContent = `[${port} - ${name}]\n` + event.data;
    // };
    ws.onmessage = event => {
        let msg;
        try {
            msg = JSON.parse(event.data);
        } catch {
            panel.pre.textContent = event.data;
            return;
        }

        if (msg.type === "log") {
            panel.pre.textContent = msg.text;
        }

        if (msg.type === "bars") {
            const chart = ensureChart(panel);
            chart.data.datasets[0].data = msg.bars.map(b => ({
                x: b.t,
                o: b.o,
                h: b.h,
                l: b.l,
                c: b.c
            }));
            chart.update();
        }
    };

    ws.onclose = () => {
        panel.textContent = `[${port} - ${name}] Connection closed\n`;
    };

    ws.onerror = () => {
        panel.textContent = `[${port} - ${name}] Error\n`;
    };

    sockets[port] = ws;
}

// -------- remove WS + clear panel ----------
function removePort(port) {
    if (sockets[port]) {
        try { sockets[port].close(); } catch(e){}
        delete sockets[port];
    }
    if (panels[port]) {
        panels[port].textContent = "";   // EMPTY, as requested
    }
}

// -------- connect to dashboard manager (port 9020) --------
const mgr = new WebSocket("ws://127.0.0.1:9020");

mgr.onmessage = (event) => {
    let endpoints;
    try {
        endpoints = JSON.parse(event.data); 
    } catch (e) {
        console.error("Invalid manager payload:", event.data);
        return;
    }

    // keys are always strings
    // ports are ordered and showed in that sequence
    const ports = Object.keys(endpoints); 

    // Add / update ports
    ports.forEach(port => {
        connectWS(port, endpoints[port]);
    });

    // Remove ports that no longer exist
    for (const port of Object.keys(sockets)) {
        if (!ports.includes(port)) {  
            removePort(port);  
        }
    }
};

mgr.onopen = () => console.log("Connected to manager (9020)");
mgr.onerror = () => console.log("Manager error");
mgr.onclose = () => console.log("Manager closed");
</script>

</body>
</html>
